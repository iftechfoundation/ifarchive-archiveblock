/*
**  mod_archiveblock.c -- Apache sample archiveblock module
**  [Autogenerated via ``apxs -n archiveblock -g'']
**
**  To play with this sample module first compile it into a
**  DSO file and install it into Apache's modules directory 
**  by running:
**
**    $ apxs -c -i mod_archiveblock.c
**
**  Then activate it in Apache's httpd.conf file for instance
**  for the URL /archiveblock in as follows:
**
**    #   httpd.conf
**    LoadModule archiveblock_module modules/mod_archiveblock.so
**    <Location /archiveblock>
**    SetHandler archiveblock
**    </Location>
**
**    Docs at: https://httpd.apache.org/docs/2.4/developer/modguide.html
**             https://httpd.apache.org/docs/2.4/programs/apxs.html
*/

#include "httpd.h"
#include "http_config.h"
#include "http_protocol.h"
#include "http_log.h"
#include "ap_config.h"

typedef struct {
    const char *mappath;
} archiveblock_config;

static archiveblock_config config;

/* The sample content handler */
static int archiveblock_handler(request_rec *r)
{
    if (strcmp(r->handler, "archiveblock")) {
        return DECLINED;
    }

    ap_log_rerror(APLOG_MARK, APLOG_CRIT, 0, r, "### config '%s'", config.mappath);
    ap_log_rerror(APLOG_MARK, APLOG_CRIT, 0, r, "### filename '%s', uri '%s', path_info '%s'", r->filename, r->uri, r->path_info);

    //### works for DECLINED for file responses but not errors
    apr_table_add(r->headers_out, "X-Frotz", "maybe");

    if (strcmp(r->uri, "/block/test.html"))
        return DECLINED;
    
    r->content_type = "text/html";
    apr_table_add(r->headers_out, "X-Zarf", "yes");

    if (!r->header_only)
        ap_rputs("The sample page from mod_archiveblock.c\n", r);
    return OK;
}

const char *archiveblock_set_path(cmd_parms *cmd, void *cfg, const char *arg)
{
    config.mappath = arg;
    return NULL;
}

static const command_rec archiveblock_directives[] = {
    AP_INIT_TAKE1("ArchiveBlockMapPath", archiveblock_set_path, NULL, RSRC_CONF, "The path to the block map."),
    { NULL }
};

static void archiveblock_register_hooks(apr_pool_t *p)
{
    config.mappath = "/Users/zarf/Downloads/mod/archiveblock/blockmap";
    
    ap_hook_handler(archiveblock_handler, NULL, NULL, APR_HOOK_MIDDLE);
}

/* Dispatch list for API hooks */
module AP_MODULE_DECLARE_DATA archiveblock_module = {
    STANDARD20_MODULE_STUFF, 
    NULL,                  /* create per-dir    config structures */
    NULL,                  /* merge  per-dir    config structures */
    NULL,                  /* create per-server config structures */
    NULL,                  /* merge  per-server config structures */
    archiveblock_directives,     /* table of config file commands */
    archiveblock_register_hooks  /* register hooks  */
};

